<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistem Prediksi Kebakaran Hutan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }
      .card {
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        border: none;
      }
      .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px 15px 0 0 !important;
        padding: 20px;
      }
      .form-control,
      .form-select {
        border-radius: 10px;
        border: 2px solid #e0e0e0;
        padding: 10px 15px;
      }
      .form-control:focus,
      .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
      }
      .btn-predict {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 10px;
        font-weight: bold;
        transition: transform 0.3s;
      }
      .btn-predict:hover {
        transform: translateY(-2px);
        color: white;
      }
      .result-box {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
        display: none;
        animation: fadeIn 0.5s;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .risk-indicator {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 10px;
      }
      .info-box {
        background: #f8f9fa;
        border-left: 4px solid #667eea;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-10">
          <div class="card">
            <div class="card-header text-center">
              <h1 class="mb-0"><i class="fas fa-fire me-2"></i>Sistem Prediksi Kebakaran Hutan</h1>
              <p class="mb-0 mt-2">Prediksi luas area kebakaran berdasarkan kondisi cuaca dan lingkungan</p>
            </div>

            <div class="card-body">
              <div class="row">
                <!-- Form Input -->
                <div class="col-md-6">
                  <form id="predictionForm">
                    <h4 class="mb-4"><i class="fas fa-cogs me-2"></i>Parameter Input</h4>

                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label class="form-label">Bulan</label>
                        <select class="form-select" name="month" required>
                          {% for key, value in month_names.items() %}
                          <option value="{{ key }}">{{ value }}</option>
                          {% endfor %}
                        </select>
                      </div>

                      <div class="col-md-6 mb-3">
                        <label class="form-label">Hari</label>
                        <select class="form-select" name="day" required>
                          {% for key, value in day_names.items() %}
                          <option value="{{ key }}">{{ value }}</option>
                          {% endfor %}
                        </select>
                      </div>
                    </div>

                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label class="form-label">FFMC</label>
                        <input type="number" class="form-control" name="ffmc" placeholder="Masukkan FFMC" step="0.1" min="0" max="100" required />
                        <small class="text-muted">Fine Fuel Moisture Code</small>
                      </div>

                      <div class="col-md-6 mb-3">
                        <label class="form-label">DMC</label>
                        <input type="number" class="form-control" name="dmc" placeholder="Masukkan DMC" step="0.1" min="0" required />
                        <small class="text-muted">Duff Moisture Code</small>
                      </div>
                    </div>

                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label class="form-label">DC</label>
                        <input type="number" class="form-control" name="dc" placeholder="Masukkan DC" step="0.1" min="0" required />
                        <small class="text-muted">Drought Code</small>
                      </div>

                      <div class="col-md-6 mb-3">
                        <label class="form-label">ISI</label>
                        <input type="number" class="form-control" name="isi" placeholder="Masukkan ISI" step="0.1" min="0" required />
                        <small class="text-muted">Initial Spread Index</small>
                      </div>
                    </div>

                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label class="form-label">Suhu (°C)</label>
                        <input type="number" class="form-control" name="temp" placeholder="Masukkan suhu" step="0.1" min="-50" max="60" required />
                      </div>

                      <div class="col-md-6 mb-3">
                        <label class="form-label">Kelembaban (%)</label>
                        <input type="number" class="form-control" name="rh" placeholder="Masukkan kelembaban" step="0.1" min="0" max="100" required />
                      </div>
                    </div>

                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label class="form-label">Kecepatan Angin (km/jam)</label>
                        <input type="number" class="form-control" name="wind" placeholder="Masukkan kecepatan angin" step="0.1" min="0" required />
                      </div>

                      <div class="col-md-6 mb-3">
                        <label class="form-label">Curah Hujan (mm)</label>
                        <input type="number" class="form-control" name="rain" placeholder="Masukkan curah hujan" step="0.1" min="0" required />
                      </div>
                    </div>

                    <!-- Koordinat opsional untuk visualisasi peta -->
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label class="form-label">Latitude (opsional)</label>
                        <input type="text" class="form-control" name="lat" placeholder="-7.25" />
                      </div>
                      <div class="col-md-6 mb-3">
                        <label class="form-label">Longitude (opsional)</label>
                        <input type="text" class="form-control" name="lon" placeholder="112.75" />
                      </div>
                    </div>

                    <div class="d-flex gap-2 mb-2">
                      <button id="autoFillBtn" type="button" class="btn btn-secondary">Deteksi Lokasi & Isi Otomatis</button>
                    </div>

                    <div class="d-grid gap-2">
                      <button type="submit" class="btn btn-predict btn-lg"><i class="fas fa-bolt me-2"></i>PREDIKSI KEBAKARAN</button>
                    </div>
                  </form>
                </div>


                </div>

                <!-- Result Display -->
                <div class="col-md-6">
                  <h4 class="mb-4"><i class="fas fa-chart-line me-2"></i>Hasil Prediksi</h4>

                  <div id="loading" class="text-center" style="display: none">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Sedang memprediksi...</p>
                  </div>

                  <div id="resultBox" class="result-box">
                    <div class="text-center mb-4">
                      <h3>PREDIKSI LUAS KEBAKARAN</h3>
                      <h1 id="predictedArea" class="display-4 fw-bold">0</h1>
                      <h5>Hektar</h5>
                    </div>

                    <div class="mb-4">
                      <h5><i class="fas fa-exclamation-triangle me-2"></i>Tingkat Risiko</h5>
                      <div class="alert" id="riskAlert">
                        <span id="riskIndicator" class="risk-indicator"></span>
                        <span id="riskLevel" class="fw-bold">-</span>
                      </div>
                    </div>

                    <div class="info-box">
                      <h6><i class="fas fa-info-circle me-2"></i>Detail Input</h6>
                      <div class="row small">
                        <div class="col-6">
                          <p><strong>Bulan:</strong> <span id="inputMonth">-</span></p>
                          <p><strong>Hari:</strong> <span id="inputDay">-</span></p>
                          <p><strong>Suhu:</strong> <span id="inputTemp">-</span></p>
                          <p><strong>Kelembaban:</strong> <span id="inputRH">-</span></p>
                        </div>
                        <div class="col-6">
                          <p><strong>Angin:</strong> <span id="inputWind">-</span></p>
                          <p><strong>Hujan:</strong> <span id="inputRain">-</span></p>
                          <p><strong>FFMC:</strong> <span id="inputFFMC">-</span></p>
                          <p><strong>DMC:</strong> <span id="inputDMC">-</span></p>
                        </div>
                      </div>
                    </div>

                    <div class="mt-3">
                      <button class="btn btn-outline-primary w-100" onclick="resetForm()"><i class="fas fa-redo me-2"></i>Prediksi Lagi</button>
                    </div>
                  </div>

                  <!-- Information Panel -->
                  <div class="mt-4">
                    <div class="info-box">
                      <h6><i class="fas fa-lightbulb me-2"></i>Informasi</h6>
                      <p class="mb-2">Sistem ini menggunakan model Machine Learning (Random Forest) yang telah dilatih dengan data historis kebakaran hutan.</p>
                      <p class="mb-0">Prediksi membantu dalam perencanaan pencegahan dan penanggulangan kebakaran.</p>
                    </div>

                    <div class="info-box">
                      <h6><i class="fas fa-shield-alt me-2"></i>Kategori Risiko</h6>
                      <div class="d-flex justify-content-between">
                        <span><span class="risk-indicator" style="background: green"></span> Rendah (< 1 ha)</span>
                        <span><span class="risk-indicator" style="background: yellow"></span> Sedang (1-10 ha)</span>
                        <span><span class="risk-indicator" style="background: orange"></span> Tinggi (10-50 ha)</span>
                        <span><span class="risk-indicator" style="background: red"></span> Sangat Tinggi (> 50 ha)</span>
                      </div>
                    </div>

                    <!-- Peta visualisasi (opsional) -->
                    <div id="map" style="height: 300px; margin-top: 15px"></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card-footer text-center text-muted">
              <small>Sistem Prediksi Kebakaran Hutan © 2024 | Dibangun dengan Flask & Machine Learning</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      // Inisialisasi peta Leaflet
      var map = L.map("map").setView([0, 0], 2);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);
      window.map = map;
      window.mapMarker = null;
      window.mapCircle = null;
      function areaHaToRadiusMeters(ha) {
        if (!ha || ha <= 0) return 50;
        return Math.sqrt((ha * 10000) / Math.PI);
      }

      document.getElementById("predictionForm").addEventListener("submit", function (e) {
        e.preventDefault();

        // Show loading
        document.getElementById("loading").style.display = "block";
        document.getElementById("resultBox").style.display = "none";

        // Collect form data
        const formData = new FormData(this);

        // Send prediction request
        fetch("/predict", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            // Hide loading
            document.getElementById("loading").style.display = "none";

            if (data.success) {
              // Update result display
              document.getElementById("predictedArea").textContent = data.predicted_area;
              document.getElementById("riskLevel").textContent = data.risk_level;

              // Update risk indicator
              const riskIndicator = document.getElementById("riskIndicator");
              riskIndicator.style.backgroundColor = data.risk_color;

              // Update alert color
              const riskAlert = document.getElementById("riskAlert");
              riskAlert.className = "alert";
              if (data.risk_color === "green") riskAlert.classList.add("alert-success");
              else if (data.risk_color === "yellow") riskAlert.classList.add("alert-warning");
              else if (data.risk_color === "orange") riskAlert.classList.add("alert-warning");
              else riskAlert.classList.add("alert-danger");

              // Update input details
              document.getElementById("inputMonth").textContent = data.month;
              document.getElementById("inputDay").textContent = data.day;
              document.getElementById("inputTemp").textContent = data.input_data.Suhu;
              document.getElementById("inputRH").textContent = data.input_data.Kelembaban;
              document.getElementById("inputWind").textContent = data.input_data.Angin;
              document.getElementById("inputRain").textContent = data.input_data.Hujan;
              document.getElementById("inputFFMC").textContent = data.input_data.FFMC;
              document.getElementById("inputDMC").textContent = data.input_data.DMC;

              // Show result box
              document.getElementById("resultBox").style.display = "block";

              // Tampilkan marker/lingkaran di peta jika koordinat diberikan
              if (data.lat != null && data.lon != null) {
                var lat = parseFloat(data.lat);
                var lon = parseFloat(data.lon);
                var radius = areaHaToRadiusMeters(data.predicted_area);
                if (window.mapMarker) {
                  window.map.removeLayer(window.mapMarker);
                  window.mapMarker = null;
                }
                if (window.mapCircle) {
                  window.map.removeLayer(window.mapCircle);
                  window.mapCircle = null;
                }
                window.mapMarker = L.marker([lat, lon]).addTo(window.map).bindPopup(`<b>${data.risk_level}</b><br>${data.predicted_area} ha`).openPopup();
                window.mapCircle = L.circle([lat, lon], { radius: radius, color: data.risk_color }).addTo(window.map);
                window.map.setView([lat, lon], 11);
              } else {
                if (window.mapMarker) {
                  window.map.removeLayer(window.mapMarker);
                  window.mapMarker = null;
                }
                if (window.mapCircle) {
                  window.map.removeLayer(window.mapCircle);
                  window.mapCircle = null;
                }
              }
            } else {
              alert("Error: " + data.error);
            }
          })
          .catch((error) => {
            document.getElementById("loading").style.display = "none";
            alert("Terjadi kesalahan: " + error);
          });
      });

      function resetForm() {
        document.getElementById("predictionForm").reset();
        document.getElementById("resultBox").style.display = "none";
      }

      // Set default values for demo
      window.onload = function () {
        // Set beberapa nilai default untuk demo
        document.getElementsByName("ffmc")[0].value = 90.6;
        document.getElementsByName("dmc")[0].value = 35.4;
        document.getElementsByName("dc")[0].value = 669.1;
        document.getElementsByName("isi")[0].value = 6.7;
        document.getElementsByName("temp")[0].value = 18;
        document.getElementsByName("rh")[0].value = 33;
        document.getElementsByName("wind")[0].value = 0.9;
        document.getElementsByName("rain")[0].value = 0;
      };

      document.getElementById('autoFillBtn').addEventListener('click', async () => {
        if (!navigator.geolocation) return alert('Geolocation tidak tersedia.');
        navigator.geolocation.getCurrentPosition(async pos => {
            const lat = pos.coords.latitude, lon = pos.coords.longitude;
            // Isi lat/lon langsung
            if (document.getElementsByName('lat')[0]) document.getElementsByName('lat')[0].value = lat;
            if (document.getElementsByName('lon')[0]) document.getElementsByName('lon')[0].value = lon;

            try {
              // Ambil cuaca sekarang dari Open-Meteo (tanpa API key)
              const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=relativehumidity_2m,precipitation&timezone=auto`;
              const res = await fetch(url);
              const json = await res.json();

              // Ambil current hour index (jaga null safety)
              const currentTime = json.current_weather && json.current_weather.time;
              const idx = (json.hourly && Array.isArray(json.hourly.time) && currentTime) ? json.hourly.time.indexOf(currentTime) : -1;
              const temp = json.current_weather && json.current_weather.temperature;
              const wind = json.current_weather && json.current_weather.windspeed;
              const rh = idx >= 0 && json.hourly.relativehumidity_2m ? json.hourly.relativehumidity_2m[idx] : null;
              const rain = idx >= 0 && json.hourly.precipitation ? json.hourly.precipitation[idx] : 0;

              // Prefill form fields (FFMC/DMC/... dibiarkan default atau isi median)
              if (temp != null && document.getElementsByName('temp')[0]) document.getElementsByName('temp')[0].value = temp;
              if (rh != null && document.getElementsByName('rh')[0]) document.getElementsByName('rh')[0].value = rh;
              if (wind != null && document.getElementsByName('wind')[0]) document.getElementsByName('wind')[0].value = wind;
              if (rain != null && document.getElementsByName('rain')[0]) document.getElementsByName('rain')[0].value = rain;

              // Set bulan/hari sesuai current time
              const d = currentTime ? new Date(currentTime) : new Date();
              const monthKeys = ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'];
              const weekdayKeys = ['sun','mon','tue','wed','thu','fri','sat'];
              if (document.getElementsByName('month')[0]) document.getElementsByName('month')[0].value = monthKeys[d.getMonth()];
              if (document.getElementsByName('day')[0]) document.getElementsByName('day')[0].value = weekdayKeys[d.getDay()];

            } catch (err) {
              alert('Gagal ambil cuaca: ' + (err.message || err));
            }

        }, err => alert('Gagal dapatkan lokasi: ' + err.message));
        });
    </script>
  </body>
</html>
